/*! Leaflet.gridcluster 2015-07-19 */
L.GridCluster=L.FeatureGroup.extend({options:{gridSize:1,zoomFactor:2,minFeaturesToCluster:2,colors:["rgb(255,255,204)","rgb(255,237,160)","rgb(254,217,118)","rgb(254,178,76)","rgb(253,141,60)","rgb(252,78,42)","rgb(227,26,28)","rgb(177,0,38)"],maxZoom:16,showGrid:!0,showCells:!0,showCentroids:!0,weightedCentroids:!1,symbolizationVariable:"value",zoomToCell:!0,cellStyle:{color:"gray",opacity:.1,fillOpacity:.5},gridStyle:{color:"gray",weight:1,opactiy:.8},symbolStyle:{color:"#013ADF",fillColor:"#013ADF",fillOpacity:.8,radius:20}},initialize:function(a){L.Util.setOptions(this,a),this.options.gridSize&&(this._currentGridSize=this.options.gridSize),this._clusterCellsGroup=L.featureGroup(),this._gridLinesGroup=L.featureGroup(),this._nonPointGroup=L.featureGroup(),this._needsClustering=[],this._originalFeaturesGroup=L.featureGroup(),this._clusters={},this._worldBounds={north:90,west:-180,east:180,south:-90},this._maxFeatures=0,this._minSymbolSize=this.options.symbolStyle.radius},addLayers:function(a){a.eachLayer(function(a){this.addLayer(a)},this),this._cluster()},addLayer:function(a){if(a instanceof L.LayerGroup){var b=[];for(var c in a._layers)b.push(a._layers[c]);return this.addLayers(b)}return a.getLatLng?this._map?(this._needsClustering.push(a),this._originalFeaturesGroup.addLayer(a),this):(this._needsClustering.push(a),this):(this._nonPointGroup.addLayer(a),this)},clearAll:function(){this._originalFeaturesGroup.clearLayers(),this._clusters={},this._map||(this._needsClustering=[],delete this._clusters),this._clusterCellsGroup.clearLayers(),this._nonPointGroup.clearLayers()},removeLayer:function(a){return this._originalFeaturesGroup.removeLayer(a),this._needsClustering=[],this._cluster(),this},hasLayer:function(a){if(!a)return!1;var b,c=this._needsClustering;for(b=c.length-1;b>=0;b--)if(c[b]===a)return!0;return!(!a.__parent||a.__parent._group!==this)||this._nonPointGroup.hasLayer(a)},setGridSize:function(a){this._currentGridSize=a,this.options.showGrid&&this._drawGrid(),this._cluster()},toggleOption:function(a,b){var c;switch(a){case"grid":c=this.options.showGrid,c?(this.options.showGrid=!1,this._gridLinesGroup.clearLayers()):(this.options.showGrid=!0,this._drawGrid());break;case"cells":c=this.options.showCells,this.options.showCells=c?!1:!0;break;case"centroids":c=this.options.showCentroids,this.options.showCentroids=c?!1:!0;break;case"labelPos":c=this.options.weightedCentroids,this.options.weightedCentroids=c?!1:!0;break;case"symbolization":c=this.options.symbolizationVariable,b?this.options.symbolizationVariable=b:("value"===c&&(this.options.symbolizationVariable="size"),"size"===c&&(this.options.symbolizationVariable="value"))}this._cluster()},onAdd:function(a){this._map=a,this._minZoom=a.getMinZoom(),this._maxZoom=a.getMaxZoom(),this._currentBounds=this._getVisibleBounds(),this._clusterCellsGroup.onAdd(a),this._gridLinesGroup.onAdd(a),this._nonPointGroup.onAdd(a),this._map.on("zoomend",this._zoomEnd,this),this._map.on("moveend",this._moveEnd,this),this._cluster()},_zoomEnd:function(a){this._map&&(this._oldZoom=this._currentZoom||this._map._zoom,this._currentZoom=this._map._zoom,this._newGridSize=this._currentGridSize,this._currentZoom>this._minZoom&&(this._currentZoom>this._oldZoom&&this.decreaseGridSize(),this._currentZoom<this._oldZoom&&this.increaseGridSize()))},_moveEnd:function(){this._map&&(this.options.showGrid&&this._drawGrid("moveend"),this._cluster())},_cluster:function(){if(this._originalFeaturesGroup.getLayers().length){this._clusterCellsGroup.clearLayers(),this._clusters={},this._maxFeatures=0,this._classDefinitions=[],this._maxSymbolSize=0;var a=this._map._zoom,b=this._currentGridSize,c=b/2,d=this._originalFeaturesGroup;this._map.removeLayer(d);var e=d.getLayers().length;this._minFeatures=e;var f=this._getVisibleBounds();if(d.eachLayer(function(d){var e=d.getLatLng(),g=d;if(e.lat>=f.south&&e.lat<=f.north&&e.lng>=f.west&&e.lng<=f.east&&a<this.options.maxZoom){var h,i,j=f.west-b;for(j;j<f.east+b;j+=b)if(e.lng<=j){i=j;break}var k=f.south-b;for(k;k<f.north+b;k+=b)if(e.lat<=k){h=k;break}var l=h+","+i,m=this._clusters;if("undefined"==typeof m[l]){var n=h-c,o=i-c,p=L.latLng(n,o),q=L.polygon([[h,i-b],[h,i],[h-b,i],[h-b,i-b]],{color:"green",weight:1});if(m[l]={count:1,color:"green",latLng:p,features:[g],polygon:q},0===this._maxSymbolSize){var r=q.getBounds().getNorthWest(),s=q.getBounds().getNorthEast();this._maxSymbolSize=.9*Math.ceil(this._map.latLngToLayerPoint(r).distanceTo(this._map.latLngToLayerPoint(s)))}}else{m[l].count+=1;var t=m[l].count;m[l].features.push(g),this._maxFeatures=t>this._maxFeatures?t:this._maxFeatures,this._minFeatures=t<this._minFeatures?t:this._minFeatures}}},this),a<this.options.maxZoom){this._numClasses=this.options.colors.length-1,this._classDefinitions=this._calculateClasses(this._numClasses);for(var g in this._clusters){var h,i=this._clusters[g].count,j=this._clusters[g];if(this.options.showCells&&j.count>this.options.minFeaturesToCluster){this._clusterCellsGroup.addLayer(j.polygon),h=this._getClassValue(i,this._classDefinitions,this.options.colors);var k=this.options.cellStyle;k.fillColor=h,j.polygon.setStyle(k).bindPopup(i+" Features")}if(1===j.count&&this.options.minFeaturesToCluster>=1&&this._clusterCellsGroup.addLayer(j.features[0]),this.options.showCentroids&&j.count>this.options.minFeaturesToCluster){var l=40,m="cluster-symbols",n=j.latLng;this.options.weightedCentroids&&(n=this._calculateCenter(j.features)),this.options.showCells||(m+=" noCells",j.symbol=this._createSymbol(j,n),this._clusterCellsGroup.addLayer(j.symbol));var o=new L.DivIcon({html:"<div><span>"+i+"</span></div>",className:m,iconSize:this.options.showCells===!0?new L.Point(30,30):new L.Point(l,l)}),p=L.marker(n,{icon:o});this._clusterCellsGroup.addLayer(p)}}}else this._originalFeaturesGroup.addTo(map)}},_createSymbol:function(a,b){var c,d=a.features.length;if(c=L.circleMarker(b,this.options.symbolStyle),"size"===this.options.symbolizationVariable||"valuesize"===this.options.symbolizationVariable){var e=this._minSymbolSize,f=this._maxSymbolSize,g=this._numClasses;this._symbolSizeDefinitions=this._calculateClasses(g,e,f);var h=this._getClassValue(d,this._classDefinitions,this._symbolSizeDefinitions)/2;c.setRadius(h)}if("value"===this.options.symbolizationVariable||"valuesize"===this.options.symbolizationVariable){var i=this._getClassValue(d,this._classDefinitions,this.options.colors);c.setStyle({fillColor:i,fillOpacity:.8,color:i})}return c},_calculateCenter:function(a){for(var b=0,c=0,d=a.length,e=0;d>e;e++){var f=a[e].getLatLng();b+=f.lat,c+=f.lng}b/=d,c/=d;var g=[b,c];return g},_calculateClasses:function(a,b,c){var d=[],e=b||this._minFeatures,f=c||this._maxFeatures,g=f-e,h=g/a;d[0]=e;var i=1;for(i;a>i;i++)d[i]=Math.round(e+h*i);return d[a]=f,d},_getClassValue:function(a,b,c){var d=b.length;d!=c.length;var e,f=0;for(f;d>f;f++){if(a<=b[f]){e=c[f];break}e=c[d]}return e},increaseGridSize:function(){var a=this.options.zoomFactor;this._newGridSize||(this._newGridSize=this._currentGridSize),this._newGridSize*=a,this._gridSizeChanged()},decreaseGridSize:function(){var a=this.options.zoomFactor;this._newGridSize||(this._newGridSize=this._currentGridSize),this._newGridSize*=1/a,this._gridSizeChanged()},_gridSizeChanged:function(){this._currentGridSize=this._newGridSize,this._cluster(),this.options.showGrid&&this._drawGrid()},_drawGrid:function(a){this._gridLinesGroup.clearLayers();var b=(this._map._zoom,this._currentGridSize),c=this._getVisibleBounds(),d=c.west,e=c.south;for(d;d<c.east;d+=b){var f=L.polyline([[c.south,d],[c.north,d]],this.options.gridStyle);this._gridLinesGroup.addLayer(f)}for(e;e<c.north;e+=b){var g=L.polyline([[e,c.east],[e,c.west]],this.options.gridStyle);this._gridLinesGroup.addLayer(g)}},_getVisibleBounds:function(){var a=this._map.getBounds();return a.east=a.getEast(),a.west=a.getWest(),a.north=a.getNorth(),a.south=a.getSouth(),a.east=a.east-a.east%this._currentGridSize+this._currentGridSize,a.west=a.west-a.west%this._currentGridSize-this._currentGridSize,a.north=a.north-a.north%this._currentGridSize+this._currentGridSize,a.south=a.south-a.south%this._currentGridSize-this._currentGridSize,a.east=a.east<=this._worldBounds.east?a.east:this._worldBounds.east,a.west=a.west>=this._worldBounds.west?a.west:this._worldBounds.west,a.north=a.north<=this._worldBounds.north?a.north:this._worldBounds.north,a.south=a.south>=this._worldBounds.south?a.south:this._worldBounds.south,a}}),L.gridCluster=function(a){return new L.GridCluster(a)};